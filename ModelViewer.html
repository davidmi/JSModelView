<!DOCTYPE html>

<html>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>
            WaveFront OBJ viewer
        </title>
        
        <script type="text/javascript" src="jquery-1.8.0.min.js"></script>
		<script type="text/javascript" src="gl-matrix-min.js"></script>
        <script type="text/javascript" src="modelview.js"></script>
		
		<script id="fragment-shader" type="x-shader/x-fragment">
			precision mediump float;

			varying vec3 vLightWeighting;

			void main(void) {
				vec3 color = vec3(1.0, 0.0, 1.0);
				gl_FragColor = vec4( color * vLightWeighting, 1.0);
			}
		</script>
		<script id="vertex-shader" type="x-shader/x-vertex">
			attribute vec3 aVertexPosition;
			attribute vec3 aVertexNormal;

			uniform mat4 uMVMatrix;
			uniform mat4 uPMatrix;
			uniform mat3 uNMatrix;

			varying vec3 vLightWeighting;

			void main(void) {
				vec3 lightDirecVector = vec3(1.0, 0, 0);
				vec3 lightColor = vec3(1.0, 1.0, 1.0);
				vec3 ambient = vec3(0.3, 0.3, 0.3);
				vec3 transformedNormal = uNMatrix * normalize(aVertexNormal);
				float directionLightWeighting = max(dot(transformedNormal , lightDirecVector), 0.0); // d
				vLightWeighting = ambient + lightColor * directionLightWeighting;

			// Incorporate the Perspective and Model-View matrix
				gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
			}
		</script>

       
        <script type="text/javascript">
            function errlog(msg){
                //Disable this and all calls to it in production
                if (typeof console != 'undefined') {
                    console.log(msg);
									
					
                }
            }
            
            function loadModel(){
                errlog(typeof document.getElementById("loadFile"));
                errlog(typeof document.getElementById("loadFile"));
                readObj(document.getElementById("loadFile").files[0]);
                //initBuffers(arr[2], arr[3]);			
            }
			
			function parseHtmlToString(id){
				var shaderScript = document.getElementById(id);
				if (!shaderScript){
					return null;
				}
				
				// Just parse the text of the shader
				var str = "";
				var k = shaderScript.firstChild;
				while (k) {
					// 3 - TEXT_NODE
					if (k.nodeType == 3){
						str += k.textContent;
					}
					k = k.nextSibling;
				}
				
				return str;
            }

            var count = 0;
            var fragmentShader;
            var vertexShader;

            function callback(data){
                count++;
                if (count < 2){
                    return;
                }
				
				// Start GL
				initGL($("#game-view")[0]);				
				
				// Try to load shaders, check if we're getting the shader text correctly
				initShaders(vertexShader, fragmentShader);
				
			    gl.clearColor(0.0, 0.0, 0.0, 1.0);
                gl.enable(gl.DEPTH_TEST);
                
                renderLoop();

                document.onkeydown = handleKeyDown;
                document.onkeyup = handleKeyUp;		
            }

		        
            $(document).ready(function (){
                errlog("This is a test");   

                //$.get("fragment_shader.txt", undefined, function(data){
					// Was loading this from another file, but this is inconvenient for
					// running the app locally. Inlined shaders for now
                    //fragmentShader = data; 
					fragmentShader = $('#fragment-shader').text();
					
                    callback();
                //});
                //$.get("vertex_shader.txt", undefined, function(data){
                    //vertexShader = data; 
					vertexShader = $('#vertex-shader').text();
                    callback();
                //});
            });
            
        </script>
        
        <style type="text/css">
            body{
                background-color: #f0f0f0;
            }
            #game-view{
                background-color: #ffffff;
            }
            
        </style>
        
    </head>

    <body>
        <canvas id="game-view" width="800px" height="600px">
            <p>Your browser does not support the canvas element. Please upgrade to Mozilla Firefox</p>
        </canvas>
        
        <input id="loadFile" type="file"></input>
        <a href="javascript:loadModel()">Load the OBJ model</a>
        
    </body>
    
</html>
